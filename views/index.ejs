<!DOCTYPE html>
<html>
<head>
  <title>Car Parts Dropshipping</title>
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://www.sandbox.paypal.com/sdk/js?client-id=<%= clientId %>" defer></script>
</head>
<body>
  <header>
    <h1>REV UP YOUR RIDE WITH PREMIUM CAR PARTS!</h1>
  </header>
  <main>
    <section id="productGrid" class="product-grid">
      <% products.forEach(product => { %>
        <div class="product-card">
          <img src="<%= product.image %>" alt="<%= product.title %>">
          <h3><%= product.title %></h3>
          <p>$<%= product.price %></p>
          <button onclick="addToCart('<%= product.id %>')">Add to Cart</button>
          <div id="paypal-button-container-<%= product.title.replace(/[^a-zA-Z0-9]/g, '-') %>" class="paypal-button"></div>
        </div>
      <% }); %>
    </section>
    <aside id="cart">
      <h2>Your Cart</h2>
      <ul id="cartItems"></ul>
      <p>Total: $<span id="cartTotal">0.00</span></p>
      <div id="paypal-button-container"></div> <!-- Standalone PayPal button for cart -->
    </aside>
    <section id="checkout" style="display:block;">
      <h2>Finalize Your Upgrade</h2>
      <form id="checkoutForm">
        <input type="text" id="name" placeholder="Name" required><br>
        <input type="tel" id="phone" placeholder="Phone" required><br>
        <input type="text" id="address" placeholder="Address" required><br>
        <input type="text" id="city" placeholder="City" required><br>
        <input type="text" id="province" placeholder="Province" required><br>
        <input type="text" id="countryCode" placeholder="Country Code" required><br>
        <input type="text" id="zip" placeholder="Zip" required><br>
        <button type="button" id="ignitePurchase">Ignite Your Purchase!</button>
      </form>
    </section>
  </main>

  <!-- Define products data as JSON -->
  <script type="application/json" id="products-data">
    <%= JSON.stringify(products) %>
  </script>

  <!-- Client-side JavaScript -->
  <script type="module" src="/js/products.js"></script>
  <script type="module" src="/js/script.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('PayPal SDK check:', typeof paypal);
      if (typeof paypal === 'undefined') {
        console.error('PayPal SDK not loaded');
        return;
      }
      // Individual product PayPal buttons
      products.forEach(product => {
        paypal.Buttons({
          createOrder: function(data, actions) {
            return actions.order.create({
              purchase_units: [{
                amount: {
                  value: product.price.toString()
                }
              }]
            });
          },
          onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
              alert('Transaction completed by ' + details.payer.name.given_name);
            });
          },
          onError: function(err) {
            console.error('PayPal Button Error:', err);
          }
        }).render(`#paypal-button-container-${product.title.replace(/[^a-zA-Z0-9]/g, '-')}`);
      });
      // Initialize cart and setup standalone PayPal button (handled by script.js)
    });
  </script>
</body>
</html>