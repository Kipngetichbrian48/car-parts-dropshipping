<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= product.title %> | Braviem</title>
  <meta name="description" content="Buy <%= product.title %> at Braviem. Fast shipping and great prices.">
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">

  <!-- PAYPAL SDK -->
  <script defer src="https://www.sandbox.paypal.com/sdk/js?client-id=<%= clientId %>&currency=USD"></script>

  <!-- Firebase SDK (as module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCfJMRpAnJB9OJTP5fzbGD0I3cmU_PfVKM",
      authDomain: "braviem.firebaseapp.com",
      projectId: "braviem",
      storageBucket: "braviem.firebasestorage.app",
      messagingSenderId: "909734678330",
      appId: "1:909734678330:web:edc9798f3d19a2030c4a03",
      measurementId: "G-0YMF3NR7KX"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    window.auth = auth;
    window.GoogleAuthProvider = GoogleAuthProvider;
    window.signInWithPopup = signInWithPopup;
    window.onAuthStateChanged = onAuthStateChanged;
    window.signOut = signOut;

    console.log('Firebase initialized');
  </script>
</head>
<body>
  <header>
    <h1>Braviem</h1>
    <p><a href="/">Back to Home</a></p>
    <div style="margin-left: auto; display: flex; align-items: center; gap: 20px;">
      <span id="userDisplay" style="font-weight: 500;">Guest</span>
      <a href="#" id="loginLink" style="color: #4285F4; font-weight: bold; text-decoration: none; cursor: pointer;">Login</a>
      <a href="#" id="logoutLink" style="display: none; color: #DB4437; font-weight: bold; text-decoration: none; cursor: pointer;">Logout</a>
    </div>
  </header>

  <!-- Login Modal -->
  <div id="loginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 40px; border-radius: 12px; text-align: center; max-width: 420px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
      <h2>Sign in or create account</h2>
      <p style="margin: 20px 0 30px; color: #333;">Save your cart, track orders, and enjoy a faster checkout</p>

      <button id="googleLoginBtn" style="padding: 12px 30px; background: #4285F4; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; width: 100%; margin-bottom: 20px;">
        Sign in with Google
      </button>

      <div style="margin: 20px 0; color: #666;">Or</div>

      <button id="createAccountBtn" style="padding: 12px 30px; background: #34A853; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; width: 100%; margin-bottom: 15px;">
        Create new account
      </button>

      <p style="margin-top: 20px;">
        <a href="#" id="forgotPassword" style="color: #4285F4; text-decoration: none; cursor: pointer;">Forgot password?</a>
      </p>

      <p style="font-size: 14px; color: #666; margin-top: 25px;">Guest checkout is always available — no account needed</p>

      <button id="closeModal" style="background: none; border: none; color: #999; margin-top: 20px; cursor: pointer; font-size: 14px;">Close</button>
    </div>
  </div>

  <main>
    <section>
      <h2><%= product.title %></h2>

      <!-- PRODUCT CAROUSEL -->
      <div class="product-carousel" data-product-id="<%= product.id %>">
        <div class="carousel-main">
          <% if (product.images?.length > 0) { %>
            <img src="<%= product.images[0] %>" alt="<%= product.title %>" class="main-image"
                 onerror="this.src='https://placehold.co/600x600/orange/white?text=No+Image'">
          <% } else { %>
            <img src="https://placehold.co/600x600/orange/white?text=No+Image" alt="No Image" class="main-image">
          <% } %>
        </div>

        <div class="carousel-thumbnails">
          <% (product.images || []).slice(1).forEach((img, i) => { %>
            <div class="carousel-slide thumbnail">
              <img src="<%= img %>" alt="<%= product.title %> - <%= i + 2 %>"
                   onerror="this.src='https://placehold.co/80x80/orange/white?text=Img'">
            </div>
          <% }); %>
        </div>
      </div>

      <!-- CURRENCY-CONVERTED PRICE -->
      <p class="product-price">
        Price: <strong data-price="<%= product.price %>">$<%= parseFloat(product.price).toFixed(2) %></strong>
      </p>

      <p>SKU: <%= product.sku || 'N/A' %></p>
      <p>Category: <%= product.category || 'Uncategorized' %></p>

      <div class="terms-conditions">
        <label>
          <input type="checkbox" id="termsCheckbox" required>
          I agree to the <a href="/terms" target="_blank">Terms and Conditions</a>
        </label>
      </div>

      <button class="add-to-cart" data-product-id="<%= product.id %>" disabled>Add to Cart</button>

      <!-- RATING SECTION -->
      <div class="rating-section">
        <h3>Rate this Product</h3>
        <form id="ratingForm">
          <select id="ratingValue" required>
            <option value="">Select Rating</option>
            <option value="5">5 Stars</option>
            <option value="4">4 Stars</option>
            <option value="3">3 Stars</option>
            <option value="2">2 Stars</option>
            <option value="1">1 Star</option>
          </select>
          <textarea id="ratingComment" placeholder="Your comment (optional)" rows="3"></textarea>
          <button type="submit">Submit Rating</button>
          <p id="ratingStatus" style="display:none;"></p>
        </form>

        <div class="ratings-list">
          <% if (ratings?.length > 0) { %>
            <% ratings.forEach(rating => { %>
              <div class="rating">
                <p>Rating:
                  <% for(let i = 1; i <= 5; i++) { %>
                    <span class="star <%= i <= rating.rating ? 'filled' : '' %>">Star</span>
                  <% } %>
                </p>
                <% if (rating.comment) { %>
                  <p><strong>Comment:</strong> <%= rating.comment %></p>
                <% } %>
                <p><small><%= new Date(rating.timestamp).toLocaleString() %></small></p>
              </div>
            <% }); %>
          <% } else { %>
            <p>No ratings yet. Be the first to rate this product!</p>
          <% } %>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <p>Shipping: 2–6 weeks via trusted partners.</p>
    <p>Licensed under the <a href="/license">MIT License</a>.</p>
  </footer>

  <%- include('partials/cart') %>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="/js/products.js"></script>
  <script src="/js/script.js"></script>

  <!-- INJECT CURRENT PRODUCT -->
  <script>
    window.products = window.products || [];
    window.cart = JSON.parse(localStorage.getItem('cart')) || {};

    const currentProduct = {
      id: "<%= product.id %>",
      title: "<%= product.title.replace(/"/g, '\\"') %>",
      price: Number(<%= product.price %>),
      images: <%- JSON.stringify(product.images || []) %>
    };

    if (!window.products.find(p => p.id === currentProduct.id)) {
      window.products.push(currentProduct);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const termsBox = document.getElementById('termsCheckbox');
      const addBtn = document.querySelector('.add-to-cart');

      if (termsBox && addBtn) {
        termsBox.addEventListener('change', () => addBtn.disabled = !termsBox.checked);
        addBtn.addEventListener('click', () => {
          if (addBtn.disabled) return;
          window.addToCart('<%= product.id %>');
          alert('Added to cart!');
        });
      }

      document.querySelectorAll('.carousel-thumbnails img').forEach(thumb => {
        thumb.style.cursor = 'pointer';
        thumb.addEventListener('click', () => {
          const main = document.querySelector('.carousel-main .main-image');
          if (main) {
            main.src = thumb.src;
            main.alt = thumb.alt;
          }
        });
      });

      const mainImg = document.querySelector('.carousel-main .main-image');
      if (mainImg) {
        mainImg.style.cursor = 'zoom-in';
        mainImg.addEventListener('click', () => window.open(mainImg.src, '_blank'));
      }
    });
  </script>
</body>
</html>